<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Internal Payment Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 720px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    label { display: block; font-size: 12px; color: #333; margin-bottom: 6px; }
    input { padding: 10px; width: 100%; box-sizing: border-box; }
    .field { flex: 1 1 220px; }
    button { padding: 10px 14px; cursor: pointer; }
    pre { background: #0b0b0b; color: #e6e6e6; padding: 12px; overflow: auto; }
    .hint { font-size: 12px; color: #666; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Internal Payment Test</h1>
  <div class="hint">This page is intended for temporary testing only. It requires the <code>t</code> query param.</div>

  <form id="form">
    <div class="row">
      <div class="field">
        <label for="phone">Phone (2547...)</label>
        <input id="phone" name="phone" value="254757238817" required />
      </div>
      <div class="field">
        <label for="amount">Amount (KES)</label>
        <input id="amount" name="amount" type="number" min="1" step="1" value="50" required />
      </div>
      <div class="field">
        <label for="ref">Account Reference</label>
        <input id="ref" name="ref" value="KEJAYACAPO-TEST" />
      </div>
    </div>

    <div style="margin-top: 12px; display: flex; gap: 10px; align-items: center;">
      <button type="submit">Send STK Push</button>
      <span class="hint" id="status"></span>
    </div>
  </form>

  <h2 style="font-size: 14px; margin-top: 18px;">Response</h2>
  <pre id="out">-</pre>

  <script>
    const params = new URLSearchParams(location.search);
    const t = params.get('t') || '';

    function setStatus(msg) {
      document.getElementById('status').textContent = msg || '';
    }

    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('Sending...');

      const phoneNumber = document.getElementById('phone').value.trim();
      const amount = Number(document.getElementById('amount').value);
      const accountReference = document.getElementById('ref').value.trim() || 'KEJAYACAPO-TEST';

      try {
        const resp = await fetch(`/api/mpesa/payment?t=${encodeURIComponent(t)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phoneNumber, amount, accountReference })
        });

        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }

        document.getElementById('out').textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        setStatus(resp.ok ? 'Done' : `Error (HTTP ${resp.status})`);
      } catch (err) {
        document.getElementById('out').textContent = String(err?.stack || err);
        setStatus('Request failed');
      }
    });
  </script>
</body>
</html>
